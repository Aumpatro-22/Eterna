{% extends 'base.html' %}
{% block title %}{% if not_found %}Chat{% else %}Chat with {{ other.username }}{% endif %}{% endblock %}

{% block content %}
{% if not_found %}
  <div class="celestial-card p-6 text-center fade-in">User not found.</div>
{% else %}
<div class="max-w-3xl mx-auto fade-in">
  <div class="celestial-card p-4 flex items-center justify-between mb-3">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-full bg-midnight-blue flex items-center justify-center text-soft-gold">
        {{ other.username.0|upper }}
      </div>
      <div>
        <div class="text-soft-gold font-medium">{{ other.username }}</div>
        <div class="text-xs text-faint-lavender">Direct messages</div>
      </div>
    </div>
    <a href="{% url 'profile' username=other.username %}" class="celestial-link text-sm"><i class="fas fa-user mr-1"></i> View Profile</a>
  </div>

  <div id="dm-log" class="celestial-card p-4 max-h-[65vh] overflow-y-auto space-y-3">
    {% for m in messages %}
      <div data-id="{{ m.id }}" class="flex {% if m.sender_id == user.id %}justify-end{% else %}justify-start{% endif %}">
        <div class="max-w-[80%] px-3 py-2 rounded {% if m.sender_id == user.id %}bg-white bg-opacity-10{% else %}bg-midnight-blue bg-opacity-60{% endif %}">
          <div class="text-xs text-faint-lavender mb-1">
            {% if m.sender_id == user.id %}You{% else %}{{ m.sender.username }}{% endif %} • {{ m.created_at|date:"M d, Y H:i" }}
          </div>
          <div class="text-ivory-white whitespace-pre-line">{{ m.content }}</div>
        </div>
      </div>
    {% empty %}
      <div class="text-center text-faint-lavender text-sm dm-empty">No messages yet. Say hello!</div>
    {% endfor %}
  </div>

  <form id="dm-send" method="post" action="{% url 'send_dm' username=other.username %}" class="mt-3 celestial-card p-3 flex gap-2 items-end">
    {% csrf_token %}
    <textarea name="message" rows="2" placeholder="Type a message…" class="flex-1 bg-transparent border border-soft-gold border-opacity-30 rounded px-3 py-2 text-ivory-white"></textarea>
    <button type="submit" class="px-4 py-2 celestial-button rounded"><i class="fas fa-paper-plane mr-2"></i>Send</button>
  </form>
</div>

{% block extra_js %}
<script>
// filepath: d:\project Eterna\templates\users\dm_thread.html
(function(){
  // Singleton guard per counterpart to prevent duplicate pollers on re-renders/navigation
  const KEY = "__dmPoll_" + "{{ other.username }}";
  if (window[KEY]?.running) { return; }
  window[KEY] = window[KEY] || {};
  window[KEY].running = true;

  const log = document.getElementById('dm-log');
  const form = document.getElementById('dm-send');
  const feedUrl = "{% url 'dm_feed' username=other.username %}";
  const initialLastTs = "{{ last_ts|default:'' }}";
  let lastTs = initialLastTs || null;

  // Track seen ids to prevent duplicates
  const seen = new Set(Array.from(log.querySelectorAll('[data-id]')).map(el => el.getAttribute('data-id')));

  // Keep handles globally to cancel on page unload or re-entry
  let pollTimer = null;
  let controller = null;

  function scrollBottom() { if (log) { log.scrollTop = log.scrollHeight; } }
  scrollBottom();

  function escapeHtml(str){return (str||'').replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));}

  function appendMsg(m){
    const id = m.id != null ? String(m.id) : null;
    if (id && seen.has(id)) return;
    if (id) seen.add(id);
    const empty = log.querySelector('.dm-empty'); if (empty) empty.remove();

    const isMe = m.sender === "{{ user.username }}";
    const wrap = document.createElement('div');
    if (id) wrap.setAttribute('data-id', id);
    wrap.className = "flex " + (isMe ? "justify-end" : "justify-start");
    wrap.innerHTML = `
      <div class="max-w-[80%] px-3 py-2 rounded ${isMe ? 'bg-white bg-opacity-10' : 'bg-midnight-blue bg-opacity-60'}">
        <div class="text-xs text-faint-lavender mb-1">${isMe ? 'You' : escapeHtml(m.sender)} • ${new Date(m.created_at).toLocaleString()}</div>
        <div class="text-ivory-white whitespace-pre-line">${escapeHtml(m.content)}</div>
      </div>`;
    log.appendChild(wrap);
    lastTs = m.created_at || lastTs;
    scrollBottom();
  }

  // Bind send once
  if (form && !form.dataset.bound) {
    form.dataset.bound = "1";
    form.addEventListener('submit', function(e){
      e.preventDefault();
      const data = new FormData(form);
      const msg = (data.get('message') || '').trim();
      if (!msg) return;
      fetch(form.action, { method:'POST', body:data, headers:{'X-Requested-With':'XMLHttpRequest'} })
        .then(r=>r.json())
        .then(res=>{
          if (res.status === 'ok') {
            appendMsg({ id: res.id, sender: "{{ user.username }}", content: msg, created_at: res.created_at_iso });
            form.reset();
          }
        });
    });
  }

  function scheduleNext() {
    if (pollTimer) clearTimeout(pollTimer);
    pollTimer = setTimeout(poll, 3000);
  }

  function poll(){
    // Abort any in-flight request before starting a new one
    if (controller) controller.abort();
    controller = new AbortController();
    const url = lastTs ? `${feedUrl}?since=${encodeURIComponent(lastTs)}` : feedUrl;
    fetch(url, { headers:{'X-Requested-With':'XMLHttpRequest', 'Cache-Control':'no-store'}, signal: controller.signal })
      .then(r=>r.json())
      .then(res=>{ (res.results||[]).forEach(appendMsg); })
      .catch(err=>{ if (err.name !== 'AbortError') console.warn('DM poll error', err); })
      .finally(scheduleNext);
  }
  poll();

  // Cleanup on unload/navigation
  window.addEventListener('beforeunload', () => {
    if (pollTimer) clearTimeout(pollTimer);
    if (controller) controller.abort();
    if (window[KEY]) window[KEY].running = false;
  });
})();
</script>
{% endblock %}
{% endif %}
{% endblock %}
